<!DOCTYPE html>
<html>
<head>
    <title>Diagn√≥stico - WhatsApp Update</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .log-line { 
            padding: 5px 0; 
            border-left: 3px solid #007acc; 
            padding-left: 10px;
            margin: 2px 0;
        }
        .success { border-left-color: #4ec9b0; color: #4ec9b0; }
        .error { border-left-color: #f48771; color: #f48771; }
        .info { border-left-color: #569cd6; color: #569cd6; }
        .warn { border-left-color: #dcdcaa; color: #dcdcaa; }
        h1 { color: #fff; }
        button {
            margin: 10px 5px;
            padding: 10px 20px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: monospace;
        }
        button:hover { background: #005a9e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Diagn√≥stico - WhatsApp Update</h1>
        
        <div style="margin: 20px 0;">
            <button onclick="testAPI()">1Ô∏è‚É£ Testar API Diretamente</button>
            <button onclick="testFrontend()">2Ô∏è‚É£ Testar Frontend</button>
            <button onclick="testBuildSaveData()">3Ô∏è‚É£ Testar buildSaveData()</button>
            <button onclick="checkDiagnostico()">4Ô∏è‚É£ Diagn√≥stico do Servidor</button>
        </div>

        <div id="logs" style="background: #252526; padding: 15px; border-radius: 4px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        const logs = document.getElementById('logs');

        function log(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(line);
            logs.scrollTop = logs.scrollHeight;
        }

        async function testAPI() {
            logs.innerHTML = '';
            log('üöÄ Testando API Diretamente...', 'info');
            
            try {
                const testData = {
                    studio: {
                        whatsapp: '+5511999888777'
                    }
                };

                log(`üì§ Enviando: ${JSON.stringify(testData)}`, 'info');
                
                const response = await fetch('/api/site-data', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ API respondeu sucesso`, 'success');
                    log(`üì• Resposta studio.whatsapp: ${data.studio?.whatsapp}`, 'success');
                } else {
                    log(`‚ùå API retornou status ${response.status}`, 'error');
                }
            } catch (err) {
                log(`‚ùå Erro: ${err.message}`, 'error');
            }
        }

        async function testFrontend() {
            logs.innerHTML = '';
            log('üåê Testando Frontend...', 'info');
            
            try {
                if (typeof api === 'undefined') {
                    log('‚ùå API helper n√£o carregado!', 'error');
                    return;
                }
                log('‚úÖ API helper est√° dispon√≠vel', 'success');

                const data = await api.getSiteData();
                log(`‚úÖ getSiteData() funcionou`, 'success');
                log(`üì¶ WhatsApp atual no banco: ${data.studio?.whatsapp}`, 'info');

            } catch (err) {
                log(`‚ùå Erro: ${err.message}`, 'error');
            }
        }

        async function testBuildSaveData() {
            logs.innerHTML = '';
            log('üî® Testando buildSaveData()...', 'info');
            
            try {
                if (typeof buildSaveData === 'undefined') {
                    log('‚ùå buildSaveData n√£o est√° definida!', 'error');
                    log('(Voc√™ precisa estar em /admin ou ter o admin.html carregado)', 'warn');
                    return;
                }

                const saveData = buildSaveData();
                log('‚úÖ buildSaveData() executada', 'success');
                log(`Studio whatsapp: ${saveData.studio?.whatsapp}`, 'info');
                log(`About title: ${saveData.about?.title}`, 'info');
                
                if (!saveData.studio?.whatsapp) {
                    log('‚ö†Ô∏è AVISO: studio.whatsapp est√° vazio!', 'warn');
                }

            } catch (err) {
                log(`‚ùå Erro: ${err.message}`, 'error');
            }
        }

        async function checkDiagnostico() {
            logs.innerHTML = '';
            log('üìä Verificando diagn√≥stico do servidor...', 'info');
            
            try {
                const response = await fetch('/api/diagnostico');
                if (response.ok) {
                    const diag = await response.json();
                    log('‚úÖ Resposta recebida', 'success');
                    log(`MongoDB: ${diag.mongo.readyStateText}`, diag.mongo.connected ? 'success' : 'error');
                    log(`Data Fetch: ${diag.dataFetch.ok ? '‚úÖ OK' : '‚ùå ERRO'}`, diag.dataFetch.ok ? 'success' : 'error');
                    log(`√öltimo WhatsApp no banco: ${diag.dataFetch.lastStudioWhatsapp}`, 'info');
                    log(`Ambiente: ${diag.environment.nodeEnv}`, 'info');
                    log(`MongoDB URI: ${diag.environment.mongodbUri}`, 'info');
                } else {
                    log(`‚ùå Erro ${response.status}`, 'error');
                }
            } catch (err) {
                log(`‚ùå Erro: ${err.message}`, 'error');
            }
        }

        log('P√°gina de diagn√≥stico carregada. Clique em um bot√£o para come√ßar.', 'info');
    </script>
</body>
</html>
